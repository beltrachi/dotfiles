#!/usr/bin/env bash
if [ $(id -u) -ne 0 ] ; then echo "Please run as root" ; exit 1 ; fi

PROC_NAME=$1

TIMES_NOT_FOUND_REQUIRED=5

TIMES_NOT_FOUND=0

while [ true ]; do

    ps aux |grep "$PROC_NAME" |grep -v grep |grep -v suspend_after > /dev/null
    RESULT=$?

    TIMES_NOT_FOUND=$(($TIMES_NOT_FOUND + $RESULT))

    if [ "$TIMES_NOT_FOUND" == "$TIMES_NOT_FOUND_REQUIRED" ]; then

	# After waiting n times ... we can suspend
        echo "No $PROC_NAME running."
        echo "suspending ..."
        sync
        pm-suspend
        exit
    else
        echo "$PROC_NAME still running. $TIMES_NOT_FOUND times not found. Has to reach $TIMES_NOT_FOUND_REQUIRED"
    fi

    sleep 60
done
